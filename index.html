<html>

<head>
    
    <script src="https://unpkg.com/realtime-bpm-analyzer@4.0.0/dist/index.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: Noto Sans;
        }

        .muteButton {
            display: block;
            margin: 10px;
            margin-right: 20px;
        }

        body {
            padding: 10px;
        }

        button {
            border-radius: 5px;
            padding: 5px;
            border-width: 1px;
        }

        .track {
            border: 1px solid lightgray;
            border-radius: 5px;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            padding: 5px;
            align-items: center;
            padding-left: 10px;
        }

        .track .label {
            width: 110px;
            text-transform: capitalize;
        }

        .track .removeButton {
            background-color: darkred;
            color: white;
            font-weight: bold;
            border: none;
            margin-left: 50px;
            height: 30px;
            width: 30px;
            cursor: pointer;
        }

        .track.muted .muteButton {
            background: red;
            color: white;

        }

        .track .volumeInput {
            margin-left: 20px;
        }

        #trackContainer {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 5px;
        }

        #fileInput {
            display: none
        }
    </style>
</head>

<body onload="init()">

    <button id="playBut" onclick="playPauseAll()">Play</button>
    <p>current time: <span id="time"></span></p>
    <button id="addTrack" onclick="addTrack()"> Add Track</button>
    <input type="file" accept="audio" id="fileInput" onchange="handleFileChange(event)" />
    <br><br>
    <div id="trackContainer">



    </div>



    <script src="track.js"></script>

    <script>

        var timer = 0
        var actx = new (AudioContext || webkitAudioContext)()
        var srcs = [
            { id: "piano", src: "wavs/!piano.wav" },
            { id: "percu", src: "wavs/!percu.wav" },
            { id: "bajo", src: "wavs/!bajo.wav" },
            //  { id: "piano2", src: "wavs/!piano.wav" },
            //  { id: "piano3", src: "wavs/!piano.wav" },
            //  { id: "piano4", src: "wavs/!piano.wav" },
            //  { id: "piano5", src: "wavs/!piano.wav" },
            //  { id: "piano6", src: "wavs/!piano.wav" },
            //  { id: "piano7", src: "wavs/!piano.wav" },
            //  { id: "percu2", src: "wavs/!percu.wav" }, 
            //  { id: "bajo2", src: "wavs/!bajo.wav" }
        ]
        var audiosArray = []
        var time = document.querySelector("#time")
        var fileInput = document.querySelector("#fileInput")
        var trackcontainer = document.querySelector("#trackContainer")
        var playing = false




        function init() {


            for (let obj of srcs) {
                audiosArray.push(new Track(obj.id, obj.src, actx, trackcontainer))
                // fetch(obj.src, { mode: "cors" }).then(resp => resp.arrayBuffer()).then(buffer => {
                //     decode(buffer, obj)
                // });
            }




            gameLoop()

        }

        function playPauseAll() {
            for (let audio of audiosArray) {
                if (audio.srcNode) {
                    audio.srcNode.stop();
                    audio.stopNode()
                    playBut.innerText = "Play";
                    playing = false
                } else {
                    // debugger                  
                    audio.playLoop()
                    playBut.innerText = "Stop";
                    playing = true
                    timer=performance.now()
                }
            }

        }

        function handleFileChange(e) {



            let reader = new FileReader();
            reader.onload = () => {

                let arrayBuffer = reader.result;
                let id = fileInput.files[0].name
                audiosArray.push(new Track(id, null, actx, trackcontainer, arrayBuffer))

            }
            reader.readAsArrayBuffer(fileInput.files[0]);

            if (playing) {
                playPauseAll()
            }

        }
        function addTrack() {
            fileInput.click()
        }


        function mute(id) {
            let audio = audiosArray.filter(k => k.id == id)[0]

            if (!audio) {
                return console.warn(audio.id + " COULD NOT BE MUTED")
            }

            audio.mute()

        }

        function gameLoop() {

            if (!playing) {
                time.innerHTML = null

            } else {
                let curTime = (performance.now() - timer) / 1000

                time.innerText = (curTime % audiosArray[0]?.duration).toFixed(2)
            }

            requestAnimationFrame(gameLoop)
        }




    </script>
</body>

</html>