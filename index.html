<html>

<head>
    <style>
        .muteButton {
            display: block;
            margin: 10px
        }

        body {
            padding: 10px;
        }
    </style>
</head>

<body onload="init()">

    <button id="playBut" onclick="playAll()">play</button>
    <br><br>
    <div id="buttonContainer">



    </div>

    <p>current time: <span id="time"></span></p>

    <script>

        var timer = 0
        var actx = new (AudioContext || webkitAudioContext)()
        var srcs = [{ id: "piano", src: "wavs/!piano.wav" }, { id: "percu", src: "wavs/!percu.wav" }, { id: "bajo", src: "wavs/!bajo.wav" }]
        var audioDatas = []
        var time = document.querySelector("#time")
        var playing = false
        // var srcNodes = [] // global so we can access them from handlers
        function init() {
            for (let obj of srcs) {



                fetch(obj.src, { mode: "cors" }).then((resp) => { return resp.arrayBuffer() }).then(buffer => {
                    decode(buffer, obj)
                });
            }


            // Simple example control
            document.querySelector("#playBut").onclick = function () {
                for (let audio of audioDatas) {
                    if (audio.srcNode) {
                        audio.srcNode.stop();
                        audio.srcNode = null;
                        this.innerText = "Play";
                        playing = false
                    } else {
                        // debugger
                        playing = true
                        playLoop(audio);
                        this.innerText = "Stop";
                    }
                }

            };

            gameLoop()

        }


        function createButton(audio) {


            document.querySelector("#buttonContainer").innerHTML += `   <button onclick="mute('${audio.id}', this)" class="muteButton file_${audio.id}"> MUTE ${audio.id}</button> duration:${audio.duration}`
        }



        function mute(id, button) {

            

            let audio = audioDatas.filter(k => k.id == id)[0]

            if (!audio) {
                return console.warn(audio.id + " COULD NOT BE MUTED")
            }


            if (audio.muted) {
                audio.gainNode.gain.value = 1
                button.innerText = "MUTE  " + audio.id
            } else {
                audio.gainNode.gain.value = -1
                button.innerText = "UNMUTE " + audio.id
            }


            audio.muted = !audio.muted

        }

        function gameLoop() {

            if (!playing) {
                time.innerHTML = null

            } else {
                let curTime = (performance.now() - timer) / 1000

                time.innerText = (curTime % audioDatas[0]?.duration).toFixed(2)
            }

            requestAnimationFrame(gameLoop)
        }




        function decode(buffer, objSrc) {

            actx.decodeAudioData(buffer, abuffer => {
                let audio = { id: objSrc.id, src: objSrc.src, abuffer, srcNode: null, duration: abuffer.duration, muted: false }
                createButton(audio)
                audioDatas.push(audio)
            });
        }

        // Sets up a new source node as needed as stopping will render current invalid
        function playLoop(audio) {

            timer = performance.now()



            let srcNode = actx.createBufferSource();  // create audio source
            srcNode.buffer = audio.abuffer;             // use decoded buffer
            srcNode.connect(actx.destination);    // create output
            srcNode.loop = true;                  // takes care of perfect looping
            audio.srcNode = srcNode;  // create a reference for control buttons
            srcNode.start(0, 0);                      // play...





            let gainNode = actx.createGain()
            // gainNode.gain.value =1 // 10 %
            gainNode.connect(actx.destination)

            // now instead of connecting to aCtx.destination, connect to the gainNode
            srcNode.connect(gainNode)
            audio.gainNode = gainNode
        }


    </script>
</body>

</html>